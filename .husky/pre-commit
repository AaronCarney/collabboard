#!/bin/sh

# Run lint-staged (format + lint changed files)
pnpm lint-staged

# Secret scanner â€” block commits containing common secret patterns
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -n "$STAGED_FILES" ]; then
  echo "Scanning staged files for secrets..."

  # Check for common secret patterns
  SECRET_PATTERNS='sk_live|sk_test|AKIA[A-Z0-9]{16}|-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY|ghp_[a-zA-Z0-9]{36}|sk-ant-api[0-9a-zA-Z-]{20,}|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9'

  for FILE in $STAGED_FILES; do
    # Skip the scanner script itself to avoid self-detection of pattern strings
    case "$FILE" in .husky/*) continue ;; esac
    if [ -f "$FILE" ]; then
      if grep -qEr "$SECRET_PATTERNS" "$FILE" 2>/dev/null; then
        echo "BLOCKED: Possible secret detected in $FILE"
        echo "Remove the secret and use an environment variable instead."
        echo "If this is a false positive, add an inline comment: # noqa: secret"
        exit 1
      fi
    fi
  done

  echo "Secret scan: clean"
fi
